<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Camera Sensor Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f0f2f5;
            padding: 20px;
        }

        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #1a237e;
            margin-bottom: 10px;
        }

        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .camera-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sensor-value {
            font-size: 2rem;
            color: #1a237e;
            margin: 10px 0;
        }

        .image-container {
            width: 100%;
            padding: 10px;
            text-align: center;
        }

        .image-container img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .button {
            background-color: #1a237e;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin: 10px 0;
            transition: background-color 0.3s;
        }

        .button:hover {
            background-color: #283593;
        }

        .error {
            color: #d32f2f;
            padding: 10px;
            background-color: #ffebee;
            border-radius: 5px;
            margin: 10px 0;
        }

        .loading {
            color: #666;
            text-align: center;
            padding: 20px;
        }

        .camera-timestamp {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .sensor-grid, .camera-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>Multi-Camera Sensor Dashboard</h1>
            <button class="button" onclick="refreshData()">Refresh Data</button>
        </div>

        <!-- Sensor Data Section -->
        <div class="sensor-grid">
            <div class="card">
                <h2>Temperature</h2>
                <div id="temperature" class="sensor-value">--</div>
            </div>
            <div class="card">
                <h2>Humidity</h2>
                <div id="humidity" class="sensor-value">--</div>
            </div>
            <div class="card">
                <h2>Pressure</h2>
                <div id="pressure" class="sensor-value">--</div>
            </div>
            <div class="card">
                <h2>Gas Resistance</h2>
                <div id="gas" class="sensor-value">--</div>
            </div>
        </div>

        <!-- Camera Section -->
        <div id="camera-grid" class="camera-grid">
            <!-- Camera cards will be dynamically added here -->
        </div>

        <!-- Download Section -->
        <div class="card">
            <h2>Downloads</h2>
            <button class="button" onclick="downloadImages()">Download All Images</button>
            <button class="button" onclick="downloadCSV()">Download Sensor Data</button>
        </div>
    </div>

    <script>
        // Function to format sensor values with units
        function formatValue(value, unit) {
            return `${parseFloat(value).toFixed(2)} ${unit}`;
        }

        // Function to fetch and update latest sensor data
        async function fetchSensorData() {
            try {
                const response = await fetch('/download_sensor_data');
                const csvText = await response.text();
                const rows = csvText.trim().split('\n');
                const latestData = rows[rows.length - 1].split(',');
                
                document.getElementById('temperature').textContent = formatValue(latestData[2], '°C');
                document.getElementById('humidity').textContent = formatValue(latestData[3], '%');
                document.getElementById('pressure').textContent = formatValue(latestData[4], 'hPa');
                document.getElementById('gas').textContent = formatValue(latestData[5], 'Ω');
            } catch (error) {
                console.error('Error fetching sensor data:', error);
                showError('Failed to fetch sensor data');
            }
        }

        // Function to get unique camera IDs and update camera grid
        async function updateCameraGrid() {
            try {
                // Get all subdirectories in the images folder
                const cameraGrid = document.getElementById('camera-grid');
                cameraGrid.innerHTML = ''; // Clear existing cameras

                // We'll get the list of camera IDs by checking the image directory structure
                const response = await fetch('/latest_image/all');
                const data = await response.json();
                const cameras = data.cameras || [];

                for (const camera of cameras) {
                    const cameraCard = createCameraCard(camera.id);
                    cameraGrid.appendChild(cameraCard);
                    updateCameraImage(camera.id, camera.latest_image);
                }
            } catch (error) {
                console.error('Error updating camera grid:', error);
                showError('Failed to update camera grid');
            }
        }

        // Function to create a camera card
        function createCameraCard(cameraId) {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <h2>Camera ${cameraId}</h2>
                <div class="image-container">
                    <img id="camera-${cameraId}" src="/api/placeholder/400/300" alt="Camera ${cameraId} view">
                    <div id="timestamp-${cameraId}" class="camera-timestamp"></div>
                </div>
            `;
            return card;
        }

        // Function to update a specific camera's image
        async function updateCameraImage(cameraId, imagePath) {
            if (imagePath) {
                const img = document.getElementById(`camera-${cameraId}`);
                img.src = `/images/${cameraId}/${imagePath}`;
                
                // Update timestamp
                const timestamp = document.getElementById(`timestamp-${cameraId}`);
                const dateStr = imagePath.split('_')[0];
                const timeStr = imagePath.split('_')[1].split('.')[0];
                timestamp.textContent = `Last updated: ${dateStr} ${timeStr.replace(/(\d{2})(\d{2})(\d{2})/, '$1:$2:$3')}`;
            }
        }

        // Function to download all images
        function downloadImages() {
            window.location.href = '/download_all_images';
        }

        // Function to download CSV data
        function downloadCSV() {
            window.location.href = '/download_sensor_data';
        }

        // Function to refresh all data
        function refreshData() {
            fetchSensorData();
            updateCameraGrid();
        }

        // Function to show error messages
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.dashboard').appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // Initial data load
        document.addEventListener('DOMContentLoaded', () => {
            refreshData();
            // Refresh data every 30 seconds
            setInterval(refreshData, 30000);
        });
    </script>
</body>
</html>